<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Meta tags for social media banners, these should be filled in appropriatly as they are your "business card" -->
  <!-- Replace the content tag with appropriate information -->
  <meta name="description" content="DESCRIPTION META TAG">
  <meta property="og:title" content="SOCIAL MEDIA TITLE TAG"/>
  <meta property="og:description" content="SOCIAL MEDIA DESCRIPTION TAG TAG"/>
  <meta property="og:url" content="URL OF THE WEBSITE"/>
  <!-- Path to banner image, should be in the path listed below. Optimal dimenssions are 1200X630-->
  <meta property="og:image" content="static/image/your_banner_image.png" />
  <meta property="og:image:width" content="1200"/>
  <meta property="og:image:height" content="630"/>


  <meta name="twitter:title" content="TWITTER BANNER TITLE META TAG">
  <meta name="twitter:description" content="TWITTER BANNER DESCRIPTION META TAG">
  <!-- Path to banner image, should be in the path listed below. Optimal dimenssions are 1200X600-->
  <meta name="twitter:image" content="static/images/your_twitter_banner_image.png">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Keywords for your paper to be indexed by-->
  <meta name="keywords" content="KEYWORDS SHOULD BE PLACED HERE">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <title>The Crystal Ball Hypothesis in diffusion models: Anticipating object positions from initial noise</title>
  <link rel="icon" type="image/x-icon" href="static/images/images.ico">
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
  rel="stylesheet">

  <link rel="stylesheet" href="static/css/bulma.min.css">
  <link rel="stylesheet" href="static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="static/css/index.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://documentcloud.adobe.com/view-sdk/main.js"></script>
  <script defer src="static/js/fontawesome.all.min.js"></script>
  <script src="static/js/bulma-carousel.min.js"></script>
  <script src="static/js/bulma-slider.min.js"></script>
  <script src="static/js/index.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    .section {
        display: flex;
        justify-content: center; /* Á¥ßÂØÜÊéíÂàóÂõæÁâá */
        align-items: center; /* ÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê */
        gap: 20px; /* ÂõæÁâá‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    }
    .org-banner {
        height: 100px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
        width: auto; /* ÂÆΩÂ∫¶ÊåâÊØî‰æãÁº©Êîæ */
    }
</style>
</head>
<body>

  <section class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <div class="columns is-centered">
          <div class="column has-text-centered">
            <h1 class="title is-1 publication-title">The Crystal Ball Hypothesis in diffusion models: Anticipating object positions from initial noise</h1>
            <div class="is-size-5 publication-authors">
              <span class="author-block">
                <a href="https://github.com/banyuanhao">Yuanhao Ban</a><sup style="color:#6fbf73;">1</sup>,</span>
              <span class="author-block">
                <a href="https://ruocwang.github.io/">Ruochen Wang</a><sup style="color:#6fbf73;">1</sup>,</span>
              <span class="author-block">
                <a href="https://tianyizhou.github.io/">Tianyi Zhou</a><sup style="color:#ed4b82">2</sup>,
              </span>
              </span>
              <a href="http://boqinggong.info/ target="_blank">Boqing Gong</a><sup style="color:#6d0194">3</sup>,
              </span>
              <span class="author-block">
                <a href="https://web.cs.ucla.edu/~chohsieh/">Cho-Jui Hsieh</a><sup style="color:#6fbf73;">1</sup>,
              </span>
              <span class="author-block">
                <a href="https://cmhcbb.github.io/">Minhao Cheng</a><sup style="color:#ffac33">4</sup>,
              </span>
            </div>
  
            <div class="is-size-5 publication-authors">
              <span class="author-block"><sup style="color:#6fbf73;">1</sup>University of California, Los Angeles,</span>
              <span class="author-block"><sup style="color:#ed4b82">2</sup>University of Maryland, College Park,</span><br>
              <span class="author-block"><sup style="color:#6d0194">3</sup>Google</span>
              <span class="author-block"><sup style="color:#ffac33">4</sup>The Pennsylvania State University</span><br>
              <span class="paper-block">
              <a href="https://turningpoint-ai.com" target="_blank" rel="external">
                <img class="center-block org-banner" src="static/images/TurningPoint_transparent_cropped.png" style="height:10em">
              </a>
              </span>
            </div>
  
            <!-- <div class="is-size-5 publication-authors">
              <span class="author-block">
                <strong><span style="font-size: 1.5em; color: crimson;">A</span></strong>IGC
                <strong><span style="font-size: 1.5em; color: crimson;">R</span></strong>esearch
                <strong><span style="font-size: 1.5em; color: crimson;">C</span></strong>ollaboration
              </span>
            </div> -->
            <!-- <div class="section" id="org-banners" style="display:fle">
              <a href="https://turningpoint-ai.com" target="_blank" rel="external">
                <img class="center-block org-banner" src="website/static/images/TurningPoint_transparent_cropped.png" style="height:15em">
              </a>
            </div> -->
          
            <!-- <section> -->
              <!-- <div class="section" id="org-banners" style="display:fle">
                <a href="https://www.ucla.edu/" target="_blank" rel="external">
                    <img class="center-block org-banner" src="website/static/images/ucla.png" style="height:3em">
                </a>
                <a href="https://www.washington.edu/" target="blank" class="ext-link">
                    <img class="center-block org-banner" src="website/static/images/uw.png" style="height:3em">
                </a>
                <a href="https://www.microsoft.com/en-us/research/" target="_blank" rel="external">
                    <img class="center-block org-banner" src="website/static/images/microsoft.png" style="height:3em">
                </a>
              </div> -->
            <!-- </section> -->
  
            <div class="column has-text-centered">
              <div class="publication-links">
                <!-- PDF Link. -->
                <span class="link-block">
                  <!-- @PAN TODO: change links -->
                  <a href="https://arxiv.org/pdf/2406.01970.pdf"
                     class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                        <i class="fas fa-file-pdf"></i>
                    </span>
                    <span>Paper</span>
                  </a>
                </span>
                <span class="link-block">
                  <a href="https://arxiv.org/abs/2406.17806"
                     class="external-link button is-normal is-rounded is-dark">
                  <!-- <a href="https://lupantech.github.io/papers/arxiv23_mathvista.pdf"
                     class="external-link button is-normal is-rounded is-dark"> -->
                    <span class="icon">
                        <i class="ai ai-arxiv"></i>
                    </span>
                    <span>arXiv</span>
                  </a>
                </span>
                <!-- Video Link. -->
                <!-- <span class="link-block">
                  <a href="https://www.youtube.com/watch?v=MrKrnHhk8IA"
                     class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                        <i class="fab fa-youtube"></i>
                    </span>
                    <span>Video</span>
                  </a>
                </span> -->
                <!-- Code Link. -->
                <span class="link-block">
                  <a href="https://github.com/banyuanhao/diffusion-noise-detector"
                     class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                        <i class="fab fa-github"></i>
                    </span>
                    <span>Code</span>
                    </a>
                </span>
                <!-- Leaderboard Link. -->
                <!-- <span class="link-block">
                  <a href="https://xirui-li.github.io/MOSSBench/#leaderboard"
                     class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                        <p style="font-size:18px">üèÜ</p>
                    </span>
                    <span>Leaderboard</span>
                  </a>
                </span> -->
                <!-- Twitter Link. -->
                <span class="link-block">
                  <a href="https://x.com/TurningPointAI/status/1807169697571553574"
                     class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                        <!-- <i class="far fa-images"></i> -->
                        <!-- üíªüîó -->
                        <p style="font-size:18px">üåê</p>
                    </span>
                    <span>Twitter</span>
                  </a>
                </span>
              </div>
  
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
<div style="width: 70%; margin: auto;">
<p> We discover the existence of trigger patches -- distinct patches in the noise space that <strong>trigger the generation of objects</strong> in the diffusion model. In the figure, we found that when replacing the target patch within another initial noise with the trigger patch, the injection position would generate an object.</p>
</div>
<img src="static/images/illu_backup.png" alt="Illustration of Trigger patch" style="display: block; margin: auto; width:50%; height:auto;margin-bottom: 5px;">

<!-- Teaser video-->
<!-- <section class="hero teaser">
  <div class="container is-max-desktop">
    <div class="hero-body">
      <video poster="" id="tree" autoplay controls muted loop height="100%">
        <source src="static/videos/banner_video.mp4"
        type="video/mp4">
      </video>
      <h2 class="subtitle has-text-centered">
        Aliquam vitae elit ullamcorper tellus egestas pellentesque. Ut lacus tellus, maximus vel lectus at, placerat pretium mi. Maecenas dignissim tincidunt vestibulum. Sed consequat hendrerit nisl ut maximus. 
      </h2>
    </div>
  </div>
</section> -->
<!-- End teaser video -->

<!-- Paper abstract -->
<section class="section hero is-light">
  <div class="container is-max-desktop">
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Abstract</h2>
        <div class="content has-text-justified">
          <p>
            In this studym we explore the role of initial noises in diffusion models. In particular, we identify specific regions, termed trigger patches, that can induce object generation in the resulting images. To identify these patches, we train a detector that anticipates these patches from the initial noise. To explain the formation of these patches, we reveal that they are outliers in Gaussian noise, and follow distinct distributions through two-sample tests. After examining the interaction between prompts and initial noises, we find the misalignment between prompts and the trigger patch patterns can result in unsuccessful image generations. The study proposes a reject-sampling strategy to obtain optimal noise, aiming to improve prompt adherence and positional diversity in image generation.
            <!-- Diffusion models have achieved remarkable success in text-to-image generation tasks; however, the role of initial noise has been rarely explored. In this study, we identify specific regions within the initial noise image, termed trigger patches, that play a key role for object generation in the resulting images. Notably, these patches are ``universal'' and can be generalized across various positions, seeds, and prompts. To be specific, extracting these patches from one noise and injecting them into another noise leads to object generation in targeted areas. We identify these patches by analyzing the dispersion of object bounding boxes across generated images, leading to the development of a posterior analysis technique.  Furthermore, we create a dataset consisting of Gaussian noises labeled with bounding boxes corresponding to the objects appearing in the generated images and train a detector that identifies these patches from the initial noise. To explain the formation of these patches, we reveal that they are outliers in Gaussian noise, and follow distinct distributions through two-sample tests. Finally, we find the misalignment between prompts and the trigger patch patterns can result in unsuccessful image generations. The study proposes a reject-sampling strategy to obtain optimal noise, aiming to improve prompt adherence and positional diversity in image generation.  -->
          </p>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- End paper abstract -->

<div style="width: 70%; margin-left: 15%;margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">How to locate Trigger patches: Post-generation Method</p>
</div>
<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <!-- <p>We generate a bunch of images using the same noise and calculate a posterior metric called ``trigger entropy'' to measure the degree of dispersion of the object bounding boxes in the generated images. A lower entropy indicates a higher likelihood that a patch is a trigger patch. The patch in the bottom row has the strongest effectiveness in inducing the generation of the object, while the objects in the top row are dispersed. So there must exist a strong trigger patch in the orange bounding box in the bottom row noise.</p>  -->
  <p>We generate a bunch of images using the same noise and find that <strong>the degree of dispersion of the object bounding boxes varies in the generated images.</strong> As shown in the figure, the objects in the top row are more dispersed than the bottom row. So there must exist a strong trigger patch in the orange bounding box in the bottom row noise, inducing the ball at the same region. To formulate the degree of dispersion, we first get the center points ($x_{c_i}$,$y_{c_i}$) of the bounding boxes and define trigger entropy as follows:</p> 
</div>

<img src="static/images/formula.png" alt="formula" style="display: block; margin: auto; width:30%; height:auto;margin-bottom: 20px;">


<img src="static/images/Triggerentropy.png" alt="Illustration of Trigger Entropy" style="display: block; margin: auto; width:40%; height:auto;margin-bottom: 20px;">


<div style="margin-left: 15%;margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">How to locate Trigger patches: Pre-generation Method</p>
</div>

<div style="width: 70%; margin:auto;margin-bottom: 5px;">
  <p>To anticipate the trigger patch before generation, we train a trigger patch detector, which functions similarly to an object detector but operates in the noise space. We perform the training in three different settings and the results are shown in the following bar chart. We find that when requiring the model to predict the object to be generated in the box, the mAP drops a lot, indicating that the trigger patches can generalize across classes.:</p>
</div>

<img src="static/images/bar_chart.png" alt="Results" style="display: block; margin: auto; width:35%; height:auto;margin-bottom: 20px;">

<div style="margin-left: 15%; margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">What contributes to the formation of trigger patches</p>
</div>

<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <p>We hypothesis that these trigger patches are typical <strong>outliers</strong> in the sampled noise, and have minimal correlation with prompts. We perform an energy-based two-sample test to compute the deviation of a patch from the original distribution. We divide 20,000 noises into ten groups according to the order of Trigger Entropy. Additionally, we craft a control group by randomly sampling from standard Gaussian distribution. We find that all the p-values between trigger patch groups and standard gaussian are 0.0, while the p-value of the control group is 0.938. Furthermore, the greater the deviation of a patch from the original distribution, the more likely it is to be a trigger patch characterized by low trigger entropy. </p>
</div>
<img src="static/images/distance_entropy.png" alt="Trigger Entropy and Energy Distance" style="display: block; margin: auto; width:35%; height:auto;margin-bottom: 20px;">

<div style="margin-left: 15%;margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">How do trigger patches and initial noises interact with each other</p>
</div>

<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <p>We wonder what happens when the prompts also contain positional information, and how do the prompt and noise interact with each other when they have aligned and contradicted object positions. So we test two initial noises with trigger patches on the left/right and two set of prompts with a template of a {class name} on the left/right. Note that there are three prompt-and-noise pairs. 1) Aligned: with a strong trigger patch on the right, 2) Contradicted: with a strong trigger patch on the left, and 3) Dispersed: with trigger patches dispersed throughout the image. After viewing the generated images, we divided them into four groups: 1) Aligned: The position of the object is aligned with the prompt guidance (On the right side). 2) Contradicted: The position of the object contradicts with the prompt guidance (On the left side). 3) Duplicated: the generated image has two objects on both sides. 4) Hard to judge (Occupying the entire picture, failed generation, or in the middle of the image) The results are as follows:<br></p>
</div>
<img src="static/images/interact.png" alt="Diversity results" style="display: block; margin: auto; width:30%; height:auto;margin-bottom: 20px;">

<div style="margin-left: 15%;margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">Application: Enhanced location diversity by removing trigger patches</p>
</div>

<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <p>Our detector can effectively mitigates positional bias, where objects tend to appear in the same location during generation. We employ a <strong>rejection sampling method</strong> that begins with detecting trigger patches in the initial noise. If the confidence scores of the bounding boxes exceed a predefined threshold, the region within the box is flagged for regeneration. This approach ensures that the noise used for generation is "pure" and free from strong trigger patches that could constrain object placement. The following figure illustrates cases with and without rejection sampling and the latter one shows greater diversity in position.<br></p>
</div>
<img src="static/images/app_div.png" alt="Diversity results" style="display: block; margin: auto; width:30%; height:auto;margin-bottom: 20px;">

<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <p>To perform a quantative analysis, we define entropy to access the diversity, which is similar to the trigger entropy, with higher values indicating greater diversity. The results are as follows:</p>
</div>
<img src="static/images/bar_chart_app_div.png" alt="Diversity results" style="display: block; margin: auto; width:30%; height:auto;margin-bottom: 20px;">

<div style="margin-left: 15%;margin-bottom: 10px;">
  <p style="font-size: 24px; font-weight: bold;">Application: Pre-generation position control</p>
</div>

<div style="width: 70%; margin: auto;margin-bottom: 5px;">
  <p>
    Our findings can contribute to controllable generation: <strong>put the trigger patch to the place you want the object to appear.</strong> To test the effectiveness of this method, we replace an arbitrary patch in a noise map with the trigger patch and then use the blended noise for generation. We sort the patches in our dataset by trigger entropy and select one every two thousand for this test. We define the injection success rate (ISR) as the ratio of successful injection cases to the total number of cases. There are two baselines as follows. 1) Resampling: Resample Gaussian noise for the target region maintaining the same mean and variance. 2) Random: Select a random patch within a source noise, which might overlap with the trigger patch in the source noise. The results are as follows:
    <br></p>
</div>
<img src="static/images/ISR.png" alt="Diversity results" style="display: block; margin: auto; width:35%; height:auto;margin-bottom: 20px;">

<!--BibTex citation -->

<section class="section" id="BibTeX">
  <div class="container is-max-desktop content">
    <h2 class="title is-3 has-text-centered">BibTeX</h2>
    <pre><code>@article{ban2024crystal,
      title={The Crystal Ball Hypothesis in diffusion models: Anticipating object positions from initial noise},
      author={Ban, Yuanhao and Wang, Ruochen and Zhou, Tianyi and Gong, Boqing and Hsieh, Cho-Jui and Cheng, Minhao},
      journal={arXiv preprint arXiv:2406.01970},
      year={2024}
    }</code></pre>
  </div>
</section>
<!--End BibTex citation -->

<section>
  <div class="section" id="org-banners">
      <a href="https://www.ucla.edu/" target="_blank" rel="external">
          <img class="center-block org-banner" src="static/images/ucla.png">
      </a>
      <a href="https://umd.edu/" target="_blank" class="ext-link">
          <img class="center-block org-banner" src="static/images/UMD.png">
      </a>
      <a href="https://www.psu.edu/" target="_blank" rel="external">
          <img class="center-block org-banner" src="static/images/pennstate.png">
      </a>
  </div>
</section>

  <footer class="footer">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content">
          <p>
            This page was built using the <a href="https://github.com/eliahuhorwitz/Academic-project-page-template" target="_blank">Academic Project Page Template</a> which was adopted from the¬†<a href="https://nerfies.github.io" target="_blank">Nerfies</a>¬†project page.
            You are free to borrow the of this website, we just ask that you link back to this page in the footer. <br> This website is licensed under a <a rel="license"  href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">Creative
            Commons Attribution-ShareAlike 4.0 International License</a>.
          </p>

        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Statcounter tracking code -->
  
<!-- You can add a tracker to track page visits by creating an account at statcounter.com -->

    <!-- End of Statcounter Code -->

  </body>
  </html>
